version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto17

  pre_build:
    commands:
      - echo Build started on `date`
      - java -version
      - echo Downloading and installing Gradle...
      - wget -q https://services.gradle.org/distributions/gradle-8.5-bin.zip
      - unzip -q gradle-8.5-bin.zip
      - export PATH=$PWD/gradle-8.5/bin:$PATH
      - gradle --version

  build:
    commands:
      - echo Building with Gradle...
      - gradle clean build -x test

  post_build:
    commands:
      - echo Build completed on `date`
      # 1. 아티팩트를 모을 임시 디렉토리를 생성합니다.
      - DEPLOY_DIR=deploy_artifact
      - mkdir -p $DEPLOY_DIR

      # 2. JAR 파일(빌드 결과물)을 임시 디렉토리로 이동/복사합니다.
      - cp build/libs/*.jar $DEPLOY_DIR/  # ★ JAR 파일 복사

      # 3. appspec.yml과 스크립트들을 복사합니다.
      - cp appspec.yml $DEPLOY_DIR/
      - cp -r scripts/ $DEPLOY_DIR/

      # 4. 임시 디렉토리의 내용을 확인합니다.
      - ls -la $DEPLOY_DIR

      - echo Creating final deployment zip manually...
      - cd $DEPLOY_DIR
      # deployment-artifact.zip 파일을 'deploy_artifact' 폴더의 내용물로 생성
      - zip -r -q ../deployment-artifact.zip .
      - cd ..
#      - echo Build completed on `date`


artifacts:
  files:
    # 🚨 이 ZIP 파일 하나만 S3에 올리도록 지정합니다.
    - 'deployment-artifact.zip'
  discard-paths: no # base-directory를 사용하지 않으므로 설정 제거